let productHTML = `
<div role="row" class="_6zbcq51i _6zbcq51h _1fragem3c _1fragem2x _6zbcq51l _6zbcq510 _6zbcq51k">
  <div role="cell" class="_6zbcq521 _6zbcq520 _1fragem3c _1fragemp7 _6zbcq51t _6zbcq51q _1fragem8w _6zbcq51o">
    <div style="--_16s97g746:6.4rem;" class="_1fragem32 _1fragemn2 _16s97g74b">
      <div class="_5uqybw0 _1fragemn2 _1fragem3c _1fragem8h">
        <div class="_5uqybw1 _1fragem3c _1fragemm3 _1fragempd _1fragem50 _1fragem6t _1fragemu _1fragemnw _1fragem8h">
          <div style="--_1m6j2n30:1;"
            class="_1m6j2n34 _1m6j2n33 _1fragemn2 _1fragemuw _1fragemoc _1m6j2n3a _1m6j2n39 _1m6j2n35 _1fragemmd">
            <picture>
              <source media="(min-width: 0px)"
                srcset="https://cdn.shopify.com/s/files/1/2340/6095/files/SavedByLogo2_64x64.png?v=1707406598 1x, https://cdn.shopify.com/s/files/1/2340/6095/files/SavedByLogo2_128x128.png?v=1707406598 2x, https://cdn.shopify.com/s/files/1/2340/6095/files/SavedByLogo2_256x256.png?v=1707406598 4x">
              <img src="https://cdn.shopify.com/s/files/1/2340/6095/files/SavedByLogo2_64x64.png?v=1707406598"
                loading="eager" alt="SavedBy Package Protection"
                class="_1h3po425 _1h3po424 _1fragem32 _1fragemly _1fragemlo _1h3po426 _1fragemqd _1fragemqb _1fragemqf _1fragemq9 _1fragemre _1fragemra _1fragemri _1fragemr6 _1fragemci _1fragemby _1fragemd2 _1fragembe _1fragemmd _1m6j2n3c _1fragempz _1fragem2x _1m6j2n35">
            </picture>
            <div class="_1m6j2n3q _1m6j2n3p _1fragemms">
              <div
                class="_1m6j2n3s _1m6j2n3r _1fragemqk _1fragemqq _1fragemr2 _1fragemqw _1fragemrf _1fragemrb _1fragemrj _1fragemr7 _1fragemj6 _1fragemhd _1fragem3c _1fragemns _1fragem87 _1m6j2n3t _1m6j2n3v _1m6j2n3l _1m6j2n3j _1fragemcn _1fragemc3 _1fragemd7 _1fragembj">
                <span class="_1m6j2n3x _1fragemtv">Quantity</span><span aria-hidden="true">1</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div role="cell" style="--_16s97g73w:6.4rem;"
    class="_6zbcq521 _6zbcq520 _1fragem3c _1fragemp7 _6zbcq51u _6zbcq51r _1fragem87 _6zbcq51p _6zbcq51n _1fragemny _6zbcq51x _6zbcq51w _1fragempa _16s97g741">
    <div class="_1fragem32 _1fragemn2 dDm6x">
      <p class="_1tx8jg70 _1fragemn2 _1tx8jg7c _1tx8jg7b _1fragempg _1tx8jg715 _1tx8jg71d _1tx8jg71f">SavedBy Package
        Protection</p>
      <div class="_1ip0g651 _1ip0g650 _1fragemn2 _1fragem5z _1fragem7s _1fragem41">
        <p class="_1tx8jg70 _1fragemn2 _1tx8jg7a _1tx8jg79 _1fragempf _1tx8jg715 _1tx8jg71e _1tx8jg71f">Tier 8</p>
        <ul class="_1ip0g651 _1ip0g650 _1fragemn2 _1fragem4g _1fragem69 _1fragem41"></ul>
        <div class="Geu8c" style="">
          <div class="M4bqA Geu8c" style="">
            <div class="_1fragem32 _1fragemn2">
              <div><button aria-busy="false" aria-label="Remove SavedBy" aria-live="polite" type="button"
                  class="_1m2hr9ge _1m2hr9gd _1fragemuk _1fragemn2 _1fragemp4 _1fragemty _1fragemud _1fragemuf _1fragemu4 _1m2hr9g1h _1m2hr9g1e _1fragemuf _1fragemud _1fragemu3 _1fragemts _1m2hr9gi _1m2hr9gg _1fragem3m _1m2hr9g1w _1m2hr9g1b _1m2hr9g1j _1m2hr9g1i _1fragemu0"><span
                    class="_1m2hr9gv _1m2hr9gu _1fragemtu _1fragemu9 _1fragemu3 _1fragemug _1m2hr9gr _1m2hr9gp _1fragem3c _1fragem87 _1fragemtw">Remove</span></button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div role="cell" class="_6zbcq521 _6zbcq520 _1fragem3c _1fragemp7 _6zbcq51u _6zbcq51r _1fragem87 _6zbcq51o _6zbcq51y">
    <div class="_6zbcq522 _1fragemtv"><span class="_19gi7yt0 _19gi7yt2 _19gi7yt12 _19gi7yt1a _19gi7yt1g">1</span></div>
  </div>
  <div role="cell"
    class="_6zbcq521 _6zbcq520 _1fragem3c _1fragemp7 _6zbcq51u _6zbcq51r _1fragem87 _6zbcq51p _6zbcq51n _1fragemny">
    <div class="_197l2ofx _1fragemp7 _1fragemnu _1fragem3c _1fragemn2 Byb5s"><span
        class="_19gi7yt0 _19gi7yt2 _19gi7yt12 _19gi7yt1a _19gi7yt1g notranslate">$12.97</span></div>
  </div>
</div>
`;

let checkoutWidgetHTML = `
<div class="Geu8c" style="">
  <div class="M4bqA Geu8c" style="">
    <div class="_1fragem32 _1fragemn2">
      <div>
        <div class="_1fragem32 _1fragemn2">
          <div class="_16s97g74v"></div>
          <div class="_1fragem32 _1fragemn2">
            <div
              class="_4jeq6k0 _1fragemn2 _1fragem50 _1fragem6t _1fragema _1fragemns _1fragem41 _1fragemnh _16s97g7f _16s97g7p _16s97g71j _16s97g71t"
              style="--_16s97g7a: minmax(auto, max-content); --_16s97g7k: minmax(0, 1fr); --_16s97g71e: minmax(auto, max-content); --_16s97g71o: minmax(0, 1fr);">
              <div>
                <div class="_1mmswk94 _1mmswk93 _1fragemn2 _1fragem3c">
                  <div class="_1mmswk96 _1mmswk95 _1fragemn2 _1fragempb"><input type="checkbox" id="DeprecatedCheckbox0"
                      class="_1mmswk98 _1mmswk97 _1fragemqf _1fragemqd _1fragemqh _1fragemqb _1fragemrf _1fragemrb _1fragemrj _1fragemr7 _1fragemci _1fragemby _1fragemd2 _1fragembe _1fragemp4 _1fragem32 _1fragemq0 _1fragem2x _1fragemu9 _1fragemu3 _1fragemug _1mmswk99 _1fragemov _1mmswk9c _1mmswk9a _1fragemus">
                    <div
                      class="_1mmswk9m _1mmswk9l _1fragemov _1fragemtu _1fragemtd _1fragemms _1fragemu3 _1fragemuj _1fragemu9">
                      <span
                        class="a8x1wu2 a8x1wu1 _1fragemq0 _1fragem2x _1fragemly _1fragemlo a8x1wu9 a8x1wui a8x1wum a8x1wuk _1fragem32 a8x1wup a8x1wuo a8x1wuw"><svg
                          xmlns="http://www.w3.org/2000/svg" viewBox="0 0 14 14" focusable="false" aria-hidden="true"
                          class="a8x1wuy a8x1wux _1fragem32 _1fragemq0 _1fragemly _1fragemlo _1fragemp6">
                          <path stroke-linecap="round" stroke-linejoin="round"
                            d="m1.5 7.097 3.596 3.602c.104.105.156.157.216.175a.25.25 0 0 0 .16-.004c.059-.022.108-.077.206-.188L12.5 3">
                          </path>
                        </svg></span>
                    </div>
                  </div>
                </div>
              </div><span
                class="_19gi7yt0 _19gi7yt2 _19gi7yti _19gi7yth _1fragemph _19gi7yt12 _19gi7yt1a _19gi7yt1g">SavedBy
                Package Protection</span>
              <div class="_197l2ofx _1fragemp7 _1fragemns _1fragem3c _1fragemn2"><button type="button"
                  class="_1m2hr9ge _1m2hr9gd _1fragemuk _1fragemn2 _1fragemp4 _1fragemty _1fragemud _1fragemuf _1fragemu4 _1m2hr9g1h _1m2hr9g1e _1fragemuf _1fragemud _1fragemu3 _1fragemts _1m2hr9gi _1m2hr9gg _1fragem3m _1m2hr9g1w _1m2hr9g1a _1m2hr9g18 _1fragemq1 _1m2hr9g1j _1m2hr9g1i _1fragemu0"
                  aria-haspopup="dialog"><span
                    class="_1m2hr9gv _1m2hr9gu _1fragemtu _1fragemu9 _1fragemu3 _1fragemug _1m2hr9gr _1m2hr9gp _1fragem3c _1fragem87 _1fragemtw"><span
                      class="a8x1wu2 a8x1wu1 _1fragemq0 _1fragem2x _1fragemly _1fragemlo a8x1wu9 a8x1wui a8x1wum a8x1wuk _1fragem32 a8x1wur a8x1wuo a8x1wuw"><svg
                        xmlns="http://www.w3.org/2000/svg" viewBox="0 0 14 14" focusable="false" aria-hidden="true"
                        class="a8x1wuy a8x1wux _1fragem32 _1fragemq0 _1fragemly _1fragemlo _1fragemp6">
                        <g clip-path="url(#a)">
                          <circle cx="7" cy="7" r="5.5"></circle>
                          <path stroke-linejoin="round" d="M6.99 10.24h.02v.02h-.02z"></path>
                          <path stroke-linecap="round"
                            d="M5.5 5.25a1.5 1.5 0 1 1 2.428 1.179C7.494 6.77 7 7.198 7 7.75"></path>
                        </g>
                        <defs>
                          <clipPath id="a">
                            <path fill="#fff" d="M0 0h14v14H0z"></path>
                          </clipPath>
                        </defs>
                      </svg></span></span></button></div>
            </div>
          </div>
          <div class="_16s97g74v"></div>
          <p class="_1tx8jg70 _1fragemn2 _1tx8jg715 _1tx8jg71d _1tx8jg71g _1tx8jg7a _1tx8jg79 _1fragempf">Add SavedBy
            for peace of mind against lost, stolen, or damaged packages.</p>
        </div>
      </div>
    </div>
  </div>
</div>
`;

console.log("Shopify Checkout Button Modifier initialized");

function formatPrice(cents) {
	return `$${(cents / 100).toFixed(2)}`;
}

let tierRate = "035";
function getFeeTiers(rate) {
	switch (rate) {
		case "035":
			return feeTiers035;
		default:
			console.warn(`Unknown tier rate: ${rate}. Defaulting to 035.`);
			return feeTiers035;
	}
}

function calculateFee(cents) {
	const feeTiers = getFeeTiers(tierRate);
	console.log("Fee tiers:", feeTiers);

	for (const tier of feeTiers) {
		if (cents <= tier.max * 100) {
			return tier.fee * 100;
		}
	}
}

function createCheckoutPlus(button, fee) {
	const style = document.createElement("style");
	style.id = "savedby-extra-css";
	style.innerHTML = `
  `;
	document.body.appendChild(style);
	const widget = document.createElement("savedby-checkout-plus");
	console.log("Creating widget for button:", button);
	widget.id = "savedby-checkout-plus-widget";
	widget.style.display = "block";
	widget.style.width = "100%";

	widget.innerHTML = `
  <style>
    .sb__parent {
      margin-bottom: 12px;
      margin-top: 16px;
      max-width: var(--container-max-width, 100%);
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .hs-site-cart-popup-layout savedby-widget .sb__container,
    #slidecarthq .sb__container,
    #rebuy-cart .sb__container,
    #rebuy-cart .sb__checkout-container {
      max-width: 100%;
    }

    .sb__info-wrapper {
      display: flex;
      width: 100%;
      line-height: 1;
      margin: 0;
      font-family: var(--info-font-family, "Montserrat", "Roboto", "Helvetica", "Arial", sans-serif);
      letter-spacing: 0.01em;
      vertical-align: middle;
    }

    .sb__info-wrapper:has(+ slot) {
      margin-bottom: 0;
    }

    .sb__info-container {
      border-radius: var(--info-border-radius, 4px);
      display: flex;
      gap: 0 8px;
      padding: 4px 8px;
      justify-content: center;
      min-height: 16px;
      background-color: var(--info-bg-color, #f5f5f5);
      color: var(--info-text-color, #000000);
      width: 100%;
      align-items: center;
      mix-blend-mode: normal;
      backdrop-filter: blur(10px);
    }

    /* INFO LOGO */

    .sb__info-logo-container {
      height: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    [data-variant=DETAILED] .sb__info-logo-container {
      height: auto;
    }

    .sb__info-logo-container>img {
      height: 100%;
      aspect-ratio: 1;
      max-width: 28px;
    }

    /* INFO CONTENT */
    .sb__info-content {
      display: flex;
      flex-direction: column;
      text-align: left;
      padding: 4px 0;
      flex: auto;
    }

    /* INFO TEXT */

    .sb__info-text-wrapper {
      flex: 1;
      display: flex;
    }

    .sb__info-text-container {
      column-gap: 4px;
      display: flex;
      flex-wrap: wrap;
      font-size: var(--info-font-size, 0.8em);
      align-items: center;
    }

    [data-variant=DETAILED] .sb__info-text-container {
      width: 100%;
    }

    .sb__info-text-container [name="title"] {
      font-size: var(--info-title-font-size, 16px);
      font-weight: 400;
      color: var(--info-title-color, inherit);
    }

    [data-variant=DETAILED] [name="title"] {
      font-size: var(--info-title-font-size, 14px);
    }

    .sb__info-container [name="description"] {
      font-weight: 100;
      white-space: nowrap;
      font-size: var(--info-desc-font-size, 1.1em);
      color: var(--info-desc-color, inherit);
    }

    [data-variant=DETAILED] [name="description"] {
      opacity: 0.8;
      font-size: var(--info-desc-font-size, 14px);
    }

    .sb__info-text-container [name="fee"] {
      font-weight: 100;
      color: var(--info-fee-color, inherit);
      font-size: var(--info-fee-font-size, 1.1em);
      text-align: right;
      flex: auto
    }

    [data-variant=SIMPLE] [name="fee"]::before {
      content: "•";
      margin: 0 4px;
    }

    [data-variant=DETAILED] [name="fee"] {
      opacity: 0.8;
    }

    /* INFO HELP BUTTON */

    .sb__info-help-button {
      /* padding-left: 4px; */
      /* background-color: red; */
      height: 18px;
      width: 18px;
      max-height: 24px;
      max-width: 24px;
      cursor: pointer;
      opacity: 0.5
    }

    [data-variant=DETAILED] .sb__info-help-button {
      /* background-color: red;s */
      height: 18px;
      width: 18px;
    }

    .sb__info-help-button>svg {
      fill: var(--info-help-color, #000000);
    }

    @media (max-width: 330px) {
      .sb__info-container {
        background-color: unset;
      }

      .sb__info-text-container {
        font-size: 12px;
      }
    }

    .sb__checkout-wrapper {
      justify-content: center;
      width: 100%;
    }

    .sb__checkout-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
      gap: 16px;
    }

    .sb__button-wrapper {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 16px;
      width: 100%;
      flex-wrap: wrap;
    }

    .sb__button {
      display: flex;
      border-radius: var(--btn-border-radius, 5px);
      height: var(--btn-height, 54px);
      justify-content: center;
      align-items: center;
      font-weight: bold;
      cursor: pointer;
      font-size: 16px;
      width: 100%;
      border-width: 0;
      font-family: var(--info-font-family, "Montserrat", "Roboto", "Helvetica", "Arial", sans-serif);
      white-space: nowrap;
    }

    .sb__checkout-button {
      background-color: var(--btn-checkout-bg-color, #000000);
      color: var(--btn-checkout-text-color, #ffffff);
    }

    .sb__checkout-button>svg {
      fill: var(--btn-checkout-text-color, #ffffff);
    }

    .sb__button:hover {
      filter: brightness(0.9);
    }

    /* TODO -- DOESNT WORK INSIDE SHADOW ROOT */
    slot[name="checkoutButton"][disabled] {
      filter: grayscale(0.9);
      cursor: not-allowed;
      opacity: 0.3;
    }

    .sb__cart-button {
      background-color: var(--btn-cart-bg-color, #ffffff);
      color: var(--btn-cart-text-color, #000000);
    }

    /* TODO -- LOADING */
    .sb__loading-icon,
    .sb__loading-icon div {
      box-sizing: border-box;
    }

    .sb__loading-icon {
      display: inline-block;
      position: relative;
      width: 80px;
      height: 80px;
    }

    .sb__loading-icon div {
      position: absolute;
      top: 33.33333px;
      width: 13.33333px;
      height: 13.33333px;
      border-radius: 50%;
      background: currentColor;
      animation-timing-function: cubic-bezier(0, 1, 1, 0);
    }

    .sb__loading-icon div:nth-child(1) {
      left: 8px;
      animation: sb__loading-icon1 0.6s infinite;
    }

    .sb__loading-icon div:nth-child(2) {
      left: 8px;
      animation: sb__loading-icon2 0.6s infinite;
    }

    .sb__loading-icon div:nth-child(3) {
      left: 32px;
      animation: sb__loading-icon2 0.6s infinite;
    }

    .sb__loading-icon div:nth-child(4) {
      left: 56px;
      animation: sb__loading-icon3 0.6s infinite;
    }

    @keyframes sb__loading-icon1 {
      0% {
        transform: scale(0);
      }

      100% {
        transform: scale(1);
      }
    }

    @keyframes sb__loading-icon3 {
      0% {
        transform: scale(1);
      }

      100% {
        transform: scale(0);
      }
    }

    @keyframes sb__loading-icon2 {
      0% {
        transform: translate(0, 0);
      }

      100% {
        transform: translate(24px, 0);
      }
    }

    .sb__continue-container {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
    }

    .sb__non-covered-link {
      color: var(--continue-text-color, #000000);
      font-size: var(--continue-font-size, 13px);
      text-decoration: var(--continue-text-decoration, underline);
      text-align: center;
      cursor: pointer;
      width: auto;
      opacity: 0.7;
      font-weight: 300;
      font-family: var(--info-font-family, "Montserrat", "Roboto", "Helvetica", "Arial", sans-serif);
    }

    div:has(>.sb__non-covered-link[disabled]) {
      cursor: not-allowed;
    }

    .sb__non-covered-link[disabled] {
      pointer-events: none;
      filter: grayscale(0.9);
    }

    .sb__disclaimer {
      color: var(--disclaimer-text-color, gray);
      font-size: var(--disclaimer-font-size, 14px);
      font-family: var(--info-font-family, "Montserrat", "Roboto", "Helvetica", "Arial", sans-serif);
      text-decoration: var(--disclaimer-text-decoration, none);
      font-style: var(--disclaimer-text-style, italic);
      font-weight: var(--disclaimer-font-weight, 300);
      line-height: 1.2;
      text-align: center;
    }
  </style>
  <div class="sb__parent">
    <div data-variant="SIMPLE" class="sb__info-wrapper">
      <div class="sb__info-container">
        <div class="sb__info-logo-container"><img alt="Protection Logo"
            src="https://cdn.savedby.io/logos/savedby/SavedByLogo-small.png"></div>
        <div class="sb__info-text-wrapper">
          <div class="sb__info-text-container"><span name="title">Checkout+</span>
            <div style="display: flex; flex-direction: row; align-items: center; justify-content: space-between;">
              <span name="description">Package Protection</span><span name="fee">$${fee || "1.67"}</span>
            </div>
          </div>
        </div>
        <div class="sb__info-help-button"><svg xmlns="http://www.w3.org/2000/svg" height="100%" focusable="false"
            aria-hidden="true" viewBox="0 0 24 24">
            <path
              d="M11 18h2v-2h-2zm1-16C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8m0-14c-2.21 0-4 1.79-4 4h2c0-1.1.9-2 2-2s2 .9 2 2c0 2-3 1.75-3 5h2c0-2.25 3-2.5 3-5 0-2.21-1.79-4-4-4">
            </path>
          </svg></div>
      </div>
    </div>
    <div class="sb__viewCart-container" style="display: none;">
      <view-cart-button />
    </div>
    <div class="sb__checkoutBtn-container">
      <checkout-button />
    </div>
    <div class="sb__continue-container">
      <a class="sb__non-covered-link">Continue without package protection</a>
    </div>
    <div class="sb__disclaimer">
      <span>We highly suggest protecting your package with Checkout+ for lost, damaged, or stolen packages.</span>
    </div>
  `;
	//copy the button node
	const btnCopy = button.cloneNode(true);
	widget.querySelector("checkout-button").replaceWith(button.cloneNode(true));
	console.log("Button replaced in widget:", btnCopy);
	const viewCartButton = button.parentNode.querySelector("a[href*='cart']");
	if (viewCartButton) {
		widget.querySelector(".sb__viewCart-container").style.display = "flex";
		widget.querySelector("view-cart-button").replaceWith(viewCartButton.cloneNode(true));
		viewCartButton.style.display = "none";
	}
	widget.querySelector("div.sb__info-container").style.borderRadius = window.getComputedStyle(button).borderRadius || "4px";
	button.replaceWith(widget);
	console.log("Widget created and button replaced:", widget);
}

function replaceTextInNode(root, newText) {
	const walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT, null);
	let node;
	while ((node = walker.nextNode())) {
		if (node.nodeValue?.trim()) {
			node.nodeValue = newText;
			break;
		}
	}
}

function updateCheckoutButton(totalPrice) {
	console.log("Updating checkout button with cart data:", totalPrice);
	const fee = calculateFee(totalPrice);
	const newTotal = totalPrice + fee;
	console.log("Calculated fee:", fee, "New total:", newTotal);
	const label = `Checkout+ ${formatPrice(newTotal)}`;

	// Enhanced button detection for any e-commerce store
	const buttonSelectors = [
		".rebuy-cart__checkout-button",
		".cart__ctas #CartDrawer-Checkout",
		".cart__ctas [name=checkout]",
		"#cart-notification-form button[name=checkout]",
		"#UpcartPopup .styles_Footer__checkoutButton__",
		"#mu-checkout-button",
		"button[data-ocu-checkout='true']",
		"button[name='checkout']",
		"button.checkout.button",
		"input[name='checkout']",
		".boost-cart__checkout-cta",
		"a[href='/checkout']",
	];

	const buttons = document.querySelectorAll(buttonSelectors.join(", "));
	if (!buttons.length) return;
	buttons.forEach((button) => {
		console.log("Found checkout button:", button);
		button.setAttribute("slot", "savedby-checkout-button");
		if (button.type === "hidden") return;
		if (button.tagName === "INPUT") {
			button.value = label;
		} else {
			replaceTextInNode(button, label);
		}
		createCheckoutPlus(button, fee / 100);
	});
}

function createCheckBoxWidget(section) {
	if (document.getElementById(`savedby-checkbox-widget-${section}`)) return;
	console.log("Creating checkbox widget...");
	const widget = document.createElement("div");
	widget.id = "savedby-checkbox-widget";
	widget.innerHTML = checkoutWidgetHTML;
	console.log("Checkbox widget created:", widget);
	return widget;
}

function displayProductInCart() {
	if (document.getElementById("savedby-product-card")) return;
	console.log("Creating product card...");
	const productCard = document.createElement("div");
	productCard.id = "savedby-product-card";
	productCard.style.marginTop = "12px";
	productCard.innerHTML = productHTML;
	console.log("Product card created:", productCard);
	return productCard;
}

function populateCheckoutPage() {
	const checkBoxWidget = createCheckBoxWidget();
	const productCard = displayProductInCart();
	const orderSummary = document.getElementById("gift-card-field");
	const productList = document.querySelector('[role="table"] [role="rowgroup"]:has([role="cell"] img)');
	if (orderSummary) {
		orderSummary.insertAdjacentElement("afterend", checkBoxWidget);
	}
	if (productList) {
		productList.insertAdjacentElement("beforeend", productCard);
	}
}

function injectLabel() {
	console.log("Injecting label into checkout page...");
	if (window.location.pathname.includes("/checkout")) {
		console.log("Checkout page detected, populating checkout page with label.");
		populateCheckoutPage();
		console.log("Shopify theme not detected, injecting label directly into checkout page.");
		return;
	}

	console.log("Shopify theme detected, fetching cart data to update checkout button.");
	fetch("/cart.js?view=checkout")
		.then((res) => res.json())
		.then((cart) => {
			updateCheckoutButton(cart.total_price);
		})
		.catch((err) => {
			console.error("Error fetching cart data:", err);
			updateCheckoutButton(7000);
		});
}

// Add a floating button to open the sidepanel
function addFloatingButton() {
	if (document.getElementById("checkout-plus-btn")) return;

	const button = document.createElement("div");
	button.id = "checkout-plus-btn";
	button.innerHTML = "🛒";
	button.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    width: 50px;
    height: 50px;
    background: #007bff;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    cursor: pointer;
    z-index: 10000;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    transition: all 0.3s ease;
  `;

	button.addEventListener("mouseenter", () => {
		button.style.transform = "scale(1.1)";
		button.style.background = "#0056b3";
	});

	button.addEventListener("mouseleave", () => {
		button.style.transform = "scale(1)";
		button.style.background = "#007bff";
	});

	button.addEventListener("click", () => {
		chrome.runtime.sendMessage({ action: "openSidepanel" });
	});

	document.body.appendChild(button);
}

// Enhanced e-commerce detection for any store
function detectEcommercePage() {
	const url = window.location.href.toLowerCase();
	const pathname = window.location.pathname.toLowerCase();

	// Common e-commerce page patterns
	const checkoutPatterns = ["/checkout"];

	// Common e-commerce button selectors
	const checkoutSelectors = [
		'button[name="checkout"]',
		'a[href*="checkout"]',
		'input[name="checkout"]',
		'button[class*="checkout"]',
		'a[class*="checkout"]',
		'button[class*="proceed"]',
		'button[class*="buy"]',
		'button[class*="purchase"]',
		'button[class*="order"]',
		'button[class*="pay"]',
		'a[class*="checkout"]',
		'a[class*="proceed"]',
		'button[class*="cart-checkout"]',
		'button[class*="cart-proceed"]',
		'[data-testid*="checkout"]',
		'[data-testid*="proceed"]',
		'button:contains("Checkout")',
		'button:contains("Proceed")',
		'button:contains("Buy")',
		'button:contains("Order")',
		'button:contains("Pay")',
		'button:contains("Purchase")',
	];

	// Check URL patterns
	const hasCheckoutUrl = pathname.includes("/checkout");

	// Check for checkout buttons
	const hasCheckoutButtons = checkoutSelectors.some((selector) => {
		try {
			return document.querySelector(selector) !== null;
		} catch (e) {
			return false;
		}
	});

	// Additional e-commerce indicators
	const hasCartIndicators = document.querySelector('[class*="cart"], [id*="cart"], [class*="basket"], [id*="basket"]') !== null;
	const hasPriceElements = document.querySelector('[class*="price"], [class*="total"], [class*="subtotal"]') !== null;

	return hasCheckoutUrl || hasCheckoutButtons || (hasCartIndicators && hasPriceElements);
}

// Reset settings when navigating to new pages
function resetSettingsForNewPage() {
	console.log("Resetting settings for new page...");

	// Reset fee tier to default
	tierRate = "035";

	// Remove any existing widgets
	removeProtection();

	// Clear any stored page-specific settings
	if (typeof chrome !== "undefined" && chrome.storage) {
		chrome.storage.local.remove(["pageSpecificSettings"], () => {
			console.log("Page-specific settings cleared");
		});
	}
}

// Track page changes
let currentUrl = window.location.href;
function checkForPageChange() {
	if (window.location.href !== currentUrl) {
		console.log("Page changed, resetting settings");
		currentUrl = window.location.href;
		resetSettingsForNewPage();
	}
}

// Initialize the content script
function init() {
	// Check if we're on an e-commerce page
	const isEcommercePage = detectEcommercePage();

	if (isEcommercePage) {
		console.log("E-commerce page detected! Ready for manual injection.");
		// Auto-injection disabled - user must manually inject via side panel
	} else {
		console.log("Not an e-commerce page - extension will not activate");
	}

	// Set up page change monitoring
	setInterval(checkForPageChange, 1000);
}

// Run initialization
if (document.readyState === "loading") {
	document.addEventListener("DOMContentLoaded", init);
} else {
	init();
}

// Remove all Checkout+ elements from the page
function removeProtection() {
	console.log("Removing Checkout+ protection...");

	// Remove all savedby widgets
	const widgets = document.querySelectorAll("savedby-checkout-plus, #savedby-checkout-plus-widget, #savedby-checkbox-widget, #savedby-product-card");
	widgets.forEach((widget) => {
		widget.remove();
		console.log("Removed widget:", widget);
	});

	// Remove floating button
	const floatingBtn = document.getElementById("checkout-plus-btn");
	if (floatingBtn) {
		floatingBtn.remove();
		console.log("Removed floating button");
	}

	// Restore original checkout buttons (this is a simplified approach)
	const checkoutButtons = document.querySelectorAll('button[name="checkout"], a[href*="checkout"], input[name="checkout"]');
	checkoutButtons.forEach((button) => {
		// Remove any Checkout+ styling or text modifications
		if (button.textContent.includes("Checkout+")) {
			button.textContent = button.textContent.replace("Checkout+", "Checkout");
		}
	});

	console.log("Checkout+ protection removed");
}

// Update settings from sidepanel
function updateSettings(settings) {
	console.log("Updating settings:", settings);

	// Update disclaimer text if provided
	if (settings.disclaimerText) {
		const disclaimers = document.querySelectorAll(".sb__disclaimer span");
		disclaimers.forEach((disclaimer) => {
			disclaimer.textContent = settings.disclaimerText;
		});
	}

	// Update fee tier if provided
	if (settings.feeTier) {
		tierRate = settings.feeTier;
		console.log("Updated fee tier to:", tierRate);
	}

	// Handle double button styling
	if (settings.enableDoubleButton !== undefined) {
		const nonCoveredLinks = document.querySelectorAll(".sb__non-covered-link");
		console.log("nonCoveredLinks", nonCoveredLinks);
		nonCoveredLinks.forEach((link) => {
			const parent = link.closest("div.sb__parent");
			if (!parent) return;
			const extraCss = document.querySelector("#savedby-extra-css");
			if (!extraCss) return;

			if (settings.enableDoubleButton) {
				console.log("enableDoubleButton", settings.enableDoubleButton);
				if (!extraCss.innerHTML.includes("double-button")) {
					const widgetButton = parent.querySelector("[slot=savedby-checkout-button]");
					const elHeight = widgetButton.offsetHeight;

					const styles = window.getComputedStyle(widgetButton);

					let backgroundColor = styles.backgroundColor;
					const borderRadius = styles.borderRadius;
					const fontSize = styles.fontSize;
					const fontFamily = styles.fontFamily;
					const fontWeight = styles.fontWeight;

					if (!backgroundColor || backgroundColor === "rgba(0, 0, 0, 0)" || backgroundColor === "transparent") {
						const effectiveBg = getEffectiveBackgroundColor(widgetButton);
						backgroundColor = effectiveBg;
					}

					// fallback if still nothing
					if (!backgroundColor || backgroundColor === "transparent") {
						backgroundColor = styles.color; // fallback to text color
					}
					console.log("elHeight", elHeight);

					extraCss.innerHTML = `
        a.sb__non-covered-link.double-button {
            color: ${backgroundColor};
            min-height: ${elHeight}px;
            border: 2px solid ${backgroundColor};
            border-radius: ${borderRadius};
            font-weight: ${fontWeight};
            font-size: ${fontSize};
            font-family: ${fontFamily || "inherit"};
            text-decoration: none;
            opacity: unset;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            box-sizing: border-box;
            padding: 0 6px;
            line-height: 1.5;
            transition: opacity .2s linear;
        }

        a.sb__non-covered-link.double-button:hover {
          opacity: .8;
        }
      `;
				}
				link.classList.add("double-button");
			} else {
				link.classList.remove("double-button");
			}
		});
	}

	// Handle disclaimer visibility
	if (settings.enableDisclaimer !== undefined) {
		const disclaimers = document.querySelectorAll(".sb__disclaimer");
		disclaimers.forEach((disclaimer) => {
			disclaimer.style.display = settings.enableDisclaimer ? "block" : "none";
		});
	}
}

// Listen for messages from the sidepanel
chrome.runtime.onMessage.addListener((message, sender, sendResponse) => {
	console.log("Content script received message:", message);

	switch (message.action) {
		case "injectCheckout":
			injectLabel();
			sendResponse({ success: true });
			break;

		case "removeProtection":
			removeProtection();
			sendResponse({ success: true });
			break;

		case "updateSettings":
			updateSettings(message.settings);
			sendResponse({ success: true });
			break;

		case "resetSettings":
			resetSettingsForNewPage();
			sendResponse({ success: true });
			break;

		default:
			sendResponse({ success: false, error: "Unknown action" });
	}

	return true; // Keep message channel open for async response
});

const feeTiers035 = [
	{
		max: 70,
		fee: 1.67,
	},
	{
		max: 100,
		fee: 2.97,
	},
	{
		max: 150,
		fee: 4.47,
	},
	{
		max: 200,
		fee: 5.97,
	},
	{
		max: 250,
		fee: 7.97,
	},
	{
		max: 300,
		fee: 9.47,
	},
	{
		max: 350,
		fee: 11.47,
	},
	{
		max: 400,
		fee: 12.97,
	},
	{
		max: 450,
		fee: 14.97,
	},
	{
		max: 500,
		fee: 16.47,
	},
	{
		max: 550,
		fee: 18.47,
	},
	{
		max: 600,
		fee: 19.97,
	},
	{
		max: 650,
		fee: 21.97,
	},
	{
		max: 700,
		fee: 23.47,
	},
	{
		max: 750,
		fee: 25.47,
	},
	{
		max: 800,
		fee: 26.97,
	},
	{
		max: 850,
		fee: 28.97,
	},
	{
		max: 900,
		fee: 30.47,
	},
	{
		max: 950,
		fee: 32.47,
	},
	{
		max: 1000,
		fee: 33.97,
	},
	{
		max: 1050,
		fee: 35.97,
	},
	{
		max: 1100,
		fee: 37.47,
	},
	{
		max: 1150,
		fee: 39.47,
	},
	{
		max: 1200,
		fee: 40.97,
	},
	{
		max: 1250,
		fee: 42.47,
	},
	{
		max: 1300,
		fee: 43.97,
	},
	{
		max: 1350,
		fee: 45.97,
	},
	{
		max: 1400,
		fee: 47.47,
	},
	{
		max: 1450,
		fee: 49.47,
	},
	{
		max: 1500,
		fee: 50.97,
	},
	{
		max: 1550,
		fee: 52.97,
	},
	{
		max: 1600,
		fee: 54.47,
	},
	{
		max: 1650,
		fee: 56.47,
	},
	{
		max: 1700,
		fee: 57.97,
	},
	{
		max: 1750,
		fee: 59.97,
	},
	{
		max: 1800,
		fee: 61.47,
	},
	{
		max: 1850,
		fee: 63.47,
	},
	{
		max: 1900,
		fee: 64.97,
	},
	{
		max: 1950,
		fee: 66.97,
	},
	{
		max: 2000,
		fee: 68.47,
	},
];
